{"version":3,"file":"route-sync.js","sources":["../../src/core/route-sync.js"],"sourcesContent":["/**\n * RouteSync - Standardized Route Synchronization Protocol\n *\n * Replaces setTimeout-based route sync with a robust, debounced event protocol.\n * Provides bidirectional route synchronization between main app and micro-apps.\n *\n * Benefits:\n * - No setTimeout hacks - pure event-driven\n * - Debounced to prevent rapid-fire events\n * - Error handling with route:error events\n * - Clean teardown to prevent memory leaks\n */\n\n/**\n * Debounce timer map for multiple micro-apps\n * Key: appName, Value: timer ID\n */\nconst debounceTimers = new Map()\n\n/**\n * Default debounce delay in milliseconds\n */\nconst DEFAULT_DEBOUNCE_DELAY = 50\n\n/**\n * RouteSync class for standardized route synchronization\n *\n * @example\n * // Main app usage (notify micro-apps of route changes)\n * const routeSync = new RouteSync('system-app', wujieBus)\n * routeSync.notifyMicroApp('/users', { page: 1 })\n *\n * @example\n * // Micro-app usage (listen for route changes from main app)\n * const routeSync = new RouteSync('system-app', window.$wujie?.bus, router)\n * routeSync.setupListener()\n * // Don't forget to teardown on unmount:\n * onUnmounted(() => routeSync.teardown())\n */\nexport class RouteSync {\n  /**\n   * Create a RouteSync instance\n   *\n   * @param {string} appName - Micro-app name (e.g., 'system-app', 'dashboard-app')\n   * @param {Object} bus - Wujie event bus instance\n   * @param {Object} [router] - Vue Router instance (required for setupListener)\n   * @param {number} [debounceDelay=50] - Debounce delay in milliseconds\n   */\n  constructor(appName, bus, router = null, debounceDelay = DEFAULT_DEBOUNCE_DELAY) {\n    if (!appName) {\n      throw new Error('RouteSync: appName is required')\n    }\n\n    this.appName = appName\n    this.bus = bus\n    this.router = router\n    this.debounceDelay = debounceDelay\n    this.eventName = `${appName}-route-change`\n    this.listenerCallback = null\n\n    // Validate bus if provided\n    if (bus && typeof bus.$emit !== 'function') {\n      console.warn(`[RouteSync] Invalid bus provided for ${appName}`)\n    }\n  }\n\n  /**\n   * Notify micro-app of route change (main app → micro-app)\n   * Uses debouncing to prevent rapid-fire events\n   *\n   * @param {string} path - Target path (e.g., '/users', '/roles')\n   * @param {Object} [query] - Query parameters\n   * @param {Object} [params] - Route parameters\n   *\n   * @example\n   * routeSync.notifyMicroApp('/users/123', { tab: 'profile' }, { id: '123' })\n   */\n  notifyMicroApp(path, query, params) {\n    if (!this.bus) {\n      console.warn(`[RouteSync] Bus not available for ${this.appName}, cannot notify`)\n      return\n    }\n\n    // Normalize path (ensure leading slash)\n    const normalizedPath = path?.startsWith('/') ? path : `/${path || ''}`\n    const finalPath = normalizedPath === '//' ? '/' : normalizedPath\n\n    // Clear existing debounce timer for this app\n    if (debounceTimers.has(this.appName)) {\n      clearTimeout(debounceTimers.get(this.appName))\n    }\n\n    // Set new debounce timer\n    const timerId = setTimeout(() => {\n      const payload = {\n        path: finalPath,\n        query,\n        params,\n        timestamp: Date.now()\n      }\n\n      try {\n        this.bus.$emit(this.eventName, payload)\n        console.log(`[RouteSync] Notified ${this.appName}:`, payload)\n      } catch (error) {\n        console.error(`[RouteSync] Error emitting route change for ${this.appName}:`, error)\n      }\n\n      // Clean up timer reference\n      debounceTimers.delete(this.appName)\n    }, this.debounceDelay)\n\n    debounceTimers.set(this.appName, timerId)\n  }\n\n  /**\n   * Set up event listener for route changes (micro-app side)\n   * Listens for route change events from main app and navigates accordingly\n   *\n   * @example\n   * // In micro-app's main.js or App.vue\n   * const routeSync = new RouteSync('system-app', window.$wujie?.bus, router)\n   * routeSync.setupListener()\n   *\n   * // Clean up on unmount\n   * onUnmounted(() => routeSync.teardown())\n   */\n  setupListener() {\n    if (!this.bus) {\n      console.warn(`[RouteSync] Bus not available for ${this.appName}, cannot setup listener`)\n      return\n    }\n\n    if (!this.router) {\n      console.warn(`[RouteSync] Router not provided for ${this.appName}, cannot setup listener`)\n      return\n    }\n\n    // Define callback function\n    this.listenerCallback = async (payload) => {\n      console.log(`[RouteSync] ${this.appName} received route change:`, payload)\n\n      try {\n        const { path, query } = payload\n\n        if (!path) {\n          console.warn(`[RouteSync] ${this.appName} received empty path, ignoring`)\n          return\n        }\n\n        // Navigate to new route\n        await this.router.push({\n          path,\n          query\n        })\n\n        console.log(`[RouteSync] ${this.appName} navigated to:`, path)\n      } catch (error) {\n        console.error(`[RouteSync] ${this.appName} navigation failed:`, error)\n\n        // Emit error event back to main app\n        this._emitError(payload.path, error)\n      }\n    }\n\n    // Register event listener\n    this.bus.$on(this.eventName, this.listenerCallback)\n\n    console.log(`[RouteSync] ${this.appName} listener set up for event: ${this.eventName}`)\n  }\n\n  /**\n   * Emit route error event (micro-app → main app)\n   * Called when navigation fails\n   *\n   * @private\n   * @param {string} path - Path that failed to navigate\n   * @param {Error} error - Error object\n   */\n  _emitError(path, error) {\n    if (!this.bus) {\n      return\n    }\n\n    const errorPayload = {\n      appName: this.appName,\n      path,\n      error: error.message || String(error),\n      stack: error.stack,\n      timestamp: Date.now()\n    }\n\n    try {\n      this.bus.$emit('route:error', errorPayload)\n      console.log(`[RouteSync] Emitted route error for ${this.appName}:`, errorPayload)\n    } catch (emitError) {\n      console.error(`[RouteSync] Failed to emit error event:`, emitError)\n    }\n  }\n\n  /**\n   * Tear down event listener and clear debounce timers\n   * Call this on component unmount to prevent memory leaks\n   *\n   * @example\n   * onUnmounted(() => {\n   *   routeSync.teardown()\n   * })\n   */\n  teardown() {\n    // Clear debounce timer if exists\n    if (debounceTimers.has(this.appName)) {\n      clearTimeout(debounceTimers.get(this.appName))\n      debounceTimers.delete(this.appName)\n    }\n\n    // Remove event listener if exists\n    if (this.bus && this.listenerCallback) {\n      this.bus.$off(this.eventName, this.listenerCallback)\n      console.log(`[RouteSync] ${this.appName} listener removed`)\n    }\n\n    this.listenerCallback = null\n  }\n\n  /**\n   * Check if listener is currently set up\n   *\n   * @returns {boolean} True if listener is active\n   */\n  isListening() {\n    return this.listenerCallback !== null\n  }\n\n  /**\n   * Get current event name\n   *\n   * @returns {string} Event name (e.g., 'system-app-route-change')\n   */\n  getEventName() {\n    return this.eventName\n  }\n}\n\n/**\n * Create a RouteSync instance with default configuration\n * Convenience factory function\n *\n * @param {string} appName - Micro-app name\n * @param {Object} bus - Wujie event bus\n * @param {Object} [router] - Vue Router instance\n * @returns {RouteSync} RouteSync instance\n */\nexport function createRouteSync(appName, bus, router) {\n  return new RouteSync(appName, bus, router)\n}\n\n/**\n * Clear all debounce timers (useful for testing)\n */\nexport function clearAllDebounceTimers() {\n  debounceTimers.forEach((timerId) => {\n    clearTimeout(timerId)\n  })\n  debounceTimers.clear()\n}\n\nexport default RouteSync\n"],"names":[],"mappings":"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"}