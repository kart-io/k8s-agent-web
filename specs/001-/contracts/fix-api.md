# Automated Fix API Contract

**Service**: analysis-service
**Base URL**: `http://localhost:8080/api/v1`
**Authentication**: Bearer token (JWT from main app)

## Endpoints

### 1. Get Automated Fixes for Issue

**Endpoint**: `GET /analysis/:runId/issues/:issueId/fixes`

**Description**: Retrieve available automated fixes for a specific issue

**Request Headers**:

```
Authorization: Bearer <jwt_token>
```

**Success Response** (200 OK):

```json
{
  "issueId": "issue-1",
  "fixes": [
    {
      "id": "fix-1",
      "fixType": "ImportPathCorrection",
      "riskLevel": "low",
      "proposedChanges": [
        {
          "filePath": "dashboard-app/src/views/Home.vue",
          "operation": "modify",
          "oldContent": "import { Button } from '../../../shared/components'",
          "newContent": "import { Button } from '@k8s-agent/shared/components'",
          "diffPreview": "@@ -1,1 +1,1 @@\n-import { Button } from '../../../shared/components'\n+import { Button } from '@k8s-agent/shared/components'\n",
          "lineNumber": 3
        }
      ],
      "affectedFiles": [
        "dashboard-app/src/views/Home.vue"
      ],
      "requiresApproval": true,
      "rollbackAvailable": true,
      "estimatedApplyTime": 500,
      "testCommand": "pnpm --filter dashboard-app lint"
    }
  ]
}
```

**Field Descriptions**:

- `fixType`: Type of automated fix (see Fix Types enum below)
- `riskLevel`: Risk assessment (low/medium/high)
- `proposedChanges`: Array of file modifications with diff previews
- `affectedFiles`: List of files that will be changed
- `requiresApproval`: Always true in current implementation
- `rollbackAvailable`: Whether git can revert these changes
- `estimatedApplyTime`: Milliseconds to apply fix
- `testCommand`: Command to run after applying fix for verification

**Error Responses**:

- **404 Not Found**: Issue or run does not exist
- **400 Bad Request**: Issue is not auto-fixable
- **401 Unauthorized**: Missing or invalid authentication token

---

### 2. Preview Fix Changes

**Endpoint**: `POST /analysis/:runId/issues/:issueId/fixes/:fixId/preview`

**Description**: Generate detailed preview of fix changes without applying them

**Request Headers**:

```
Authorization: Bearer <jwt_token>
Content-Type: application/json
```

**Request Body**:

```json
{
  "includeContext": true,
  "contextLines": 5
}
```

**Field Descriptions**:

- `includeContext` (optional): Include surrounding code lines in preview (default: true)
- `contextLines` (optional): Number of context lines before/after change (default: 3)

**Success Response** (200 OK):

```json
{
  "fixId": "fix-1",
  "preview": {
    "files": [
      {
        "filePath": "dashboard-app/src/views/Home.vue",
        "changes": [
          {
            "lineNumber": 3,
            "oldContent": "import { Button } from '../../../shared/components'",
            "newContent": "import { Button } from '@k8s-agent/shared/components'",
            "context": {
              "before": [
                "<script setup>",
                "import { ref } from 'vue'"
              ],
              "after": [
                "import { Card } from '@k8s-agent/shared/components'",
                ""
              ]
            },
            "unifiedDiff": "@@ -1,5 +1,5 @@\n <script setup>\n import { ref } from 'vue'\n-import { Button } from '../../../shared/components'\n+import { Button } from '@k8s-agent/shared/components'\n import { Card } from '@k8s-agent/shared/components'\n"
          }
        ],
        "totalChanges": 1,
        "addedLines": 1,
        "removedLines": 1
      }
    ],
    "summary": {
      "totalFiles": 1,
      "totalChanges": 1,
      "addedLines": 1,
      "removedLines": 1,
      "netLineChange": 0
    }
  },
  "riskAssessment": {
    "level": "low",
    "reasons": [
      "Only modifies import paths, no logic changes",
      "Automated tests available",
      "Changes are reversible via git"
    ],
    "potentialIssues": []
  }
}
```

**Error Responses**:

- **404 Not Found**: Fix, issue, or run does not exist
- **401 Unauthorized**: Missing or invalid authentication token

---

### 3. Apply Automated Fix

**Endpoint**: `POST /analysis/:runId/issues/:issueId/fixes/:fixId/apply`

**Description**: Apply automated fix to the codebase (requires approval)

**Request Headers**:

```
Authorization: Bearer <jwt_token>
Content-Type: application/json
```

**Request Body**:

```json
{
  "approvedBy": "user-uuid",
  "runTests": true,
  "createGitCommit": true,
  "commitMessage": "fix(shared): correct import paths\n\nAuto-fix applied for issue-1\n\nðŸ¤– Generated by Architecture Analysis System"
}
```

**Field Descriptions**:

- `approvedBy` (required): User ID of person approving the fix
- `runTests` (optional): Execute `testCommand` after applying (default: true)
- `createGitCommit` (optional): Create git commit for changes (default: true)
- `commitMessage` (optional): Custom commit message (default: auto-generated)

**Success Response** (200 OK):

```json
{
  "fixId": "fix-1",
  "status": "applied",
  "appliedAt": "2025-10-09T11:45:30Z",
  "approvedBy": "user-uuid",
  "results": {
    "filesModified": [
      "dashboard-app/src/views/Home.vue"
    ],
    "linesChanged": 1,
    "testsRan": true,
    "testsPassed": true,
    "testOutput": "âœ“ dashboard-app lint passed (125ms)",
    "gitCommit": "def789abc123"
  },
  "rollbackCommand": "git revert def789abc123"
}
```

**Partial Success Response** (207 Multi-Status):

```json
{
  "fixId": "fix-1",
  "status": "applied_with_warnings",
  "appliedAt": "2025-10-09T11:45:30Z",
  "approvedBy": "user-uuid",
  "results": {
    "filesModified": [
      "dashboard-app/src/views/Home.vue"
    ],
    "linesChanged": 1,
    "testsRan": true,
    "testsPassed": false,
    "testOutput": "âœ— dashboard-app lint failed\n  Unexpected token at line 5",
    "gitCommit": null
  },
  "warnings": [
    "Tests failed after applying fix",
    "Changes not committed due to test failure"
  ],
  "rollbackCommand": "git checkout HEAD -- dashboard-app/src/views/Home.vue",
  "recommendation": "Manual review required. Run 'pnpm --filter dashboard-app lint' to diagnose."
}
```

**Error Responses**:

- **404 Not Found**: Fix, issue, or run does not exist
- **400 Bad Request**: Missing required fields or fix already applied
- **401 Unauthorized**: Missing or invalid authentication token
- **403 Forbidden**: User not authorized to apply fixes
- **409 Conflict**: Codebase has uncommitted changes
- **500 Internal Server Error**: Fix application failed

---

### 4. Rollback Applied Fix

**Endpoint**: `POST /analysis/:runId/issues/:issueId/fixes/:fixId/rollback`

**Description**: Revert a previously applied fix

**Request Headers**:

```
Authorization: Bearer <jwt_token>
Content-Type: application/json
```

**Request Body**:

```json
{
  "reason": "Fix caused unintended side effects",
  "rolledBackBy": "user-uuid"
}
```

**Success Response** (200 OK):

```json
{
  "fixId": "fix-1",
  "status": "rolled_back",
  "rolledBackAt": "2025-10-09T12:00:00Z",
  "rolledBackBy": "user-uuid",
  "reason": "Fix caused unintended side effects",
  "results": {
    "gitRevert": "commit ghi012jkl345",
    "filesRestored": [
      "dashboard-app/src/views/Home.vue"
    ]
  }
}
```

**Error Responses**:

- **404 Not Found**: Fix was not applied or does not exist
- **400 Bad Request**: Fix not eligible for rollback
- **401 Unauthorized**: Missing or invalid authentication token
- **409 Conflict**: Conflicting changes since fix was applied

---

### 5. Batch Apply Fixes

**Endpoint**: `POST /analysis/:runId/fixes/batch-apply`

**Description**: Apply multiple fixes in a single transaction

**Request Headers**:

```
Authorization: Bearer <jwt_token>
Content-Type: application/json
```

**Request Body**:

```json
{
  "fixes": [
    {
      "issueId": "issue-1",
      "fixId": "fix-1"
    },
    {
      "issueId": "issue-3",
      "fixId": "fix-3"
    }
  ],
  "approvedBy": "user-uuid",
  "runTests": true,
  "createGitCommit": true,
  "commitMessage": "fix(multiple): batch apply automated fixes\n\nApplied fixes for issues: issue-1, issue-3\n\nðŸ¤– Generated by Architecture Analysis System"
}
```

**Success Response** (200 OK):

```json
{
  "batchId": "batch-uuid",
  "status": "completed",
  "appliedAt": "2025-10-09T11:50:00Z",
  "results": {
    "totalFixes": 2,
    "successful": 2,
    "failed": 0,
    "fixes": [
      {
        "issueId": "issue-1",
        "fixId": "fix-1",
        "status": "applied",
        "filesModified": ["dashboard-app/src/views/Home.vue"]
      },
      {
        "issueId": "issue-3",
        "fixId": "fix-3",
        "status": "applied",
        "filesModified": ["agent-app/vite.config.js"]
      }
    ],
    "testsRan": true,
    "testsPassed": true,
    "gitCommit": "mno345pqr678"
  },
  "rollbackCommand": "git revert mno345pqr678"
}
```

**Partial Success Response** (207 Multi-Status):

```json
{
  "batchId": "batch-uuid",
  "status": "partial",
  "appliedAt": "2025-10-09T11:50:00Z",
  "results": {
    "totalFixes": 2,
    "successful": 1,
    "failed": 1,
    "fixes": [
      {
        "issueId": "issue-1",
        "fixId": "fix-1",
        "status": "applied",
        "filesModified": ["dashboard-app/src/views/Home.vue"]
      },
      {
        "issueId": "issue-3",
        "fixId": "fix-3",
        "status": "failed",
        "error": "File has uncommitted changes"
      }
    ],
    "testsRan": false,
    "gitCommit": null
  },
  "rollbackCommand": "git checkout HEAD -- dashboard-app/src/views/Home.vue"
}
```

**Error Responses**:

- **400 Bad Request**: Invalid fix IDs or empty batch
- **401 Unauthorized**: Missing or invalid authentication token
- **409 Conflict**: Codebase has uncommitted changes

---

## Data Types

### FixType Enum

- `ConfigurationUpdate` - Modify configuration files (vite.config.js, etc.)
- `ImportPathCorrection` - Fix import paths to use shared library
- `FormatFix` - Code formatting corrections
- `GuardAddition` - Add missing route guards
- `CORSEnablement` - Enable CORS in vite configs

### RiskLevel Enum

- `low` - Safe changes (formatting, imports)
- `medium` - Configuration changes (may affect behavior)
- `high` - Logic changes (use with extreme caution)

### FixStatus Enum

- `proposed` - Fix generated but not applied
- `applied` - Fix successfully applied
- `applied_with_warnings` - Applied but tests failed or warnings issued
- `failed` - Application failed
- `rolled_back` - Fix was reverted

---

## Validation Rules

1. **Approval Required**: All fixes require `approvedBy` user ID before application
2. **Clean Working Directory**: Fixes cannot be applied if repository has uncommitted changes
3. **Test Execution**: If `runTests` is true and tests fail, changes are not committed
4. **Rollback Eligibility**: Fixes can only be rolled back within 24 hours of application
5. **Batch Atomicity**: Batch fixes applied as single git commit; partial failures roll back entire batch

---

## Security Considerations

- **File System Access**: Fix application requires write access to repository
- **Command Execution**: Test commands executed in isolated shell environment
- **Audit Trail**: All fix applications logged with user ID, timestamp, and changes
- **Rollback Protection**: Only users who applied a fix (or admins) can roll it back

---

## Notes

- Maximum 50 fixes per batch apply request
- Fix previews cached for 5 minutes
- Applied fixes cannot be modified, only rolled back
- Test command timeouts after 2 minutes
- All file modifications preserve original encoding and line endings
