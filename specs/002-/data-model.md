# Data Model: 微前端架构优化

**Feature**: 002- 微前端架构优化
**Date**: 2025-10-09
**Status**: Complete

## Overview

This document defines the data structures and relationships for the centralized configuration system, route synchronization protocol, shared state management, and error reporting in the K8s Agent Web micro-frontend architecture.

## 1. Configuration Data Model

### MicroAppConfig

Central configuration entity for each micro-application.

**Schema**:

```javascript
{
  name: String,              // Unique identifier, e.g., "dashboard-app"
  port: Number,              // Development server port, e.g., 3001
  basePath: String,          // URL base path, e.g., "/dashboard"
  entry: {
    development: String,     // Dev URL, e.g., "//localhost:3001"
    test: String,            // Test env URL, e.g., "//test-server:3001"
    production: String       // Prod URL, e.g., "/micro-apps/dashboard/"
  },
  metadata: {
    version: String,         // Semantic version, e.g., "1.2.3"
    owner: String,           // Team/maintainer, e.g., "team-dashboard"
    description: String,     // Brief description
    icon?: String            // Optional icon URL
  },
  wujie: {
    exec: Boolean,           // Execute scripts (default: true)
    alive: Boolean,          // Keep-alive mode (default: true)
    sync: Boolean,           // Route sync enabled (default: true)
    props?: Object           // Optional custom props
  }
}
```

**Validation Rules**:
- `name`: Required, alphanumeric + hyphens, unique across all apps
- `port`: Required, 3000-3999 range, unique across all apps
- `basePath`: Required, must start with `/`, matches route prefix
- `entry.development`: Required, must be valid URL
- `entry.production`: Required for production builds
- `metadata.version`: Must follow semver format (e.g., `1.0.0`)
- `wujie.*`: All booleans, defaults provided if omitted

**Relationships**:
- One-to-one with route configuration in `main-app/src/router/index.js`
- Referenced by `MicroAppContainer` component for URL resolution
- Used by Wujie registration in `wujie-config.js`

**Example**:

```javascript
const DASHBOARD_CONFIG = {
  name: 'dashboard-app',
  port: 3001,
  basePath: '/dashboard',
  entry: {
    development: '//localhost:3001',
    test: '//test.example.com/dashboard',
    production: '/micro-apps/dashboard/'
  },
  metadata: {
    version: '1.0.0',
    owner: 'team-platform',
    description: '仪表盘应用 - 提供系统概览和统计数据'
  },
  wujie: {
    exec: true,
    alive: true,
    sync: true
  }
}
```

---

## 2. Route Synchronization Data Model

### RouteEvent

Event payload for route synchronization between main app and micro-apps.

**Schema**:

```javascript
{
  type: 'sync' | 'report' | 'error',  // Event type
  sourceApp: String,                   // Originating app name
  targetApp: String,                   // Destination app name (for 'sync')
  path: String,                        // Relative path, e.g., "/users"
  fullPath: String,                    // Complete path with query/hash
  meta: {
    title?: String,                    // Page title
    requiresAuth?: Boolean,            // Auth requirement
    [key: String]: any                 // Additional metadata
  },
  timestamp: Number                    // Unix timestamp (ms)
}
```

**Event Types**:
- `sync`: Main app → micro-app route navigation command
- `report`: Micro-app → main app route change notification
- `error`: Route sync failure notification

**Validation Rules**:
- `type`: Required, one of enum values
- `sourceApp`: Required, must match registered app name
- `targetApp`: Required for `type: 'sync'`, optional otherwise
- `path`: Required, must start with `/`
- `fullPath`: Required, includes `path` + query + hash
- `timestamp`: Auto-generated, Unix epoch in milliseconds

**Relationships**:
- Generated by `RouteSync` class methods
- Consumed by Wujie event bus listeners
- Linked to Vue Router navigation guards

**Examples**:

```javascript
// Sync event (main → micro-app)
{
  type: 'sync',
  sourceApp: 'main-app',
  targetApp: 'system-app',
  path: '/users',
  fullPath: '/system/users?page=1',
  meta: { title: '用户管理', requiresAuth: true },
  timestamp: 1696834567890
}

// Report event (micro-app → main)
{
  type: 'report',
  sourceApp: 'system-app',
  targetApp: 'main-app',
  path: '/users/123',
  fullPath: '/system/users/123?tab=profile',
  meta: { title: '用户详情' },
  timestamp: 1696834567900
}

// Error event
{
  type: 'error',
  sourceApp: 'main-app',
  targetApp: 'cluster-app',
  path: '/nodes',
  fullPath: '/clusters/nodes',
  meta: { error: 'Navigation cancelled', reason: 'app_not_loaded' },
  timestamp: 1696834567910
}
```

---

## 3. Shared State Data Model

### SharedState

Reactive state entity shared across micro-apps.

**Schema**:

```javascript
{
  namespace: String,         // State category, e.g., "user", "notification"
  key: String,               // State identifier, e.g., "userInfo", "unreadCount"
  value: any,                // State value (any serializable type)
  timestamp: Number,         // Last update time (Unix ms)
  version?: Number           // Optional version for conflict resolution
}
```

**Validation Rules**:
- `namespace`: Required, alphanumeric + underscores, max 32 chars
- `key`: Required, alphanumeric + underscores, max 64 chars
- `value`: Must be JSON-serializable (no functions, symbols)
- `timestamp`: Auto-generated on state update
- Full key format: `${namespace}:${key}` (e.g., `user:info`)

**Relationships**:
- Managed by `SharedStateManager` class
- Stored in Vue reactive object (`reactive({})`)
- Broadcasted via Wujie event bus on updates
- Subscribed by multiple micro-apps

**State Lifecycle**:
1. **Creation**: `setState(namespace, key, value)` → reactive state + event emission
2. **Propagation**: Event bus broadcasts to all micro-apps
3. **Subscription**: Micro-apps register callbacks via `subscribe(namespace, key, callback)`
4. **Cleanup**: Subscriptions removed on app unmount

**Namespace Conventions**:
- `user`: User profile, preferences, auth status
- `notification`: Unread counts, alerts
- `permission`: Role changes, access control updates
- `system`: Global app settings, feature flags

**Examples**:

```javascript
// User info state
{
  namespace: 'user',
  key: 'info',
  value: {
    id: 123,
    username: 'admin',
    avatar: '/avatars/admin.png',
    roles: ['admin', 'developer']
  },
  timestamp: 1696834567890,
  version: 1
}

// Notification count state
{
  namespace: 'notification',
  key: 'unreadCount',
  value: 5,
  timestamp: 1696834567900
}

// Permission update state
{
  namespace: 'permission',
  key: 'roleChanged',
  value: {
    userId: 123,
    newRoles: ['viewer'],
    reason: 'demoted_by_admin'
  },
  timestamp: 1696834567910
}
```

---

## 4. Error Reporting Data Model

### ErrorInfo

Error information captured by error boundaries and reported to monitoring.

**Schema**:

```javascript
{
  appName: String,                    // Micro-app identifier
  errorType: 'load' | 'runtime' | 'navigation',  // Error category
  message: String,                    // Error message
  stack: String,                      // Stack trace
  timestamp: Number,                  // Occurrence time (Unix ms)
  context: {
    route?: String,                   // Current route
    userInfo?: Object,                // User context
    browserInfo?: Object,             // Browser/device info
    previousRoute?: String            // Navigation source
  },
  severity: 'critical' | 'error' | 'warning',  // Error severity
  recovered: Boolean                  // Whether error was recovered
}
```

**Error Types**:
- `load`: Micro-app failed to load (network, 404, timeout)
- `runtime`: JavaScript error during execution
- `navigation`: Route navigation failure

**Severity Levels**:
- `critical`: App completely unavailable, blocks user workflow
- `error`: Feature broken, partial functionality remains
- `warning`: Minor issue, full functionality available

**Validation Rules**:
- `appName`: Required, must match registered app name
- `errorType`: Required, one of enum values
- `message`: Required, non-empty string
- `stack`: Optional but recommended for debugging
- `timestamp`: Auto-generated
- `severity`: Required, defaults to 'error' if not specified

**Relationships**:
- Generated by `ErrorBoundary` component
- Passed to `reportError()` utility function
- Sent to monitoring service (console.log, Sentry, DataDog)
- May trigger fallback UI rendering

**Examples**:

```javascript
// Load error
{
  appName: 'cluster-app',
  errorType: 'load',
  message: 'Failed to fetch micro-app resource',
  stack: 'Error: net::ERR_CONNECTION_REFUSED\n  at fetch...',
  timestamp: 1696834567890,
  context: {
    route: '/clusters',
    userInfo: { id: 123, username: 'admin' },
    browserInfo: { userAgent: 'Chrome/118.0', platform: 'MacOS' }
  },
  severity: 'critical',
  recovered: false
}

// Runtime error
{
  appName: 'system-app',
  errorType: 'runtime',
  message: 'Cannot read property "name" of undefined',
  stack: 'TypeError: Cannot read property...\n  at UserList.vue:42',
  timestamp: 1696834567900,
  context: {
    route: '/system/users',
    previousRoute: '/system/roles',
    userInfo: { id: 456 }
  },
  severity: 'error',
  recovered: true  // Error boundary caught it
}
```

---

## 5. Configuration Schema (JSON Schema)

**File**: `config/micro-apps.schema.json`

Validation schema for `micro-apps.config.js` configuration files.

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "patternProperties": {
    "^[a-z0-9-]+$": {
      "type": "object",
      "required": ["name", "port", "basePath", "entry"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "description": "Unique micro-app identifier"
        },
        "port": {
          "type": "integer",
          "minimum": 3000,
          "maximum": 3999,
          "description": "Development server port"
        },
        "basePath": {
          "type": "string",
          "pattern": "^/[a-z0-9-]+$",
          "description": "URL base path"
        },
        "entry": {
          "type": "object",
          "required": ["development", "production"],
          "properties": {
            "development": { "type": "string", "format": "uri" },
            "test": { "type": "string", "format": "uri" },
            "production": { "type": "string", "format": "uri" }
          }
        },
        "metadata": {
          "type": "object",
          "properties": {
            "version": {
              "type": "string",
              "pattern": "^\\d+\\.\\d+\\.\\d+$"
            },
            "owner": { "type": "string" },
            "description": { "type": "string" }
          }
        },
        "wujie": {
          "type": "object",
          "properties": {
            "exec": { "type": "boolean", "default": true },
            "alive": { "type": "boolean", "default": true },
            "sync": { "type": "boolean", "default": true }
          }
        }
      }
    }
  }
}
```

---

## 6. Data Flow Diagrams

### Configuration Loading Flow

```
[Config File] → [Config Loader] → [Validation] → [Environment Selection]
                                        ↓
                              [Main App Wujie Config]
                                        ↓
                              [Micro-App Registration]
```

### Route Sync Flow

```
[User Navigation] → [Main App Router] → [RouteSync.notifyMicroApp()]
                                              ↓
                                    [Wujie Event Bus]
                                              ↓
                              [Micro-App RouteSync.setupListener()]
                                              ↓
                                    [Micro-App Router.push()]
```

### State Sync Flow

```
[Micro-App Action] → [SharedStateManager.setState()] → [Event Bus Broadcast]
                                                              ↓
                                        [All Subscribed Micro-Apps Receive Update]
                                                              ↓
                                                  [Reactive State Update]
                                                              ↓
                                                  [Vue Component Re-render]
```

---

## 7. Storage and Persistence

### LocalStorage Schema

Configuration and state caching in browser localStorage.

**Keys**:
- `micro_apps_config`: Cached configuration (JSON string)
- `shared_state_${namespace}_${key}`: Persisted state values
- `error_history`: Recent error logs (circular buffer, max 50 entries)

**Example**:

```javascript
// localStorage.getItem('micro_apps_config')
{
  "dashboard-app": { /* MicroAppConfig */ },
  "agent-app": { /* MicroAppConfig */ },
  // ... other apps
}

// localStorage.getItem('shared_state_user_info')
{
  "id": 123,
  "username": "admin",
  "avatar": "/avatars/admin.png"
}
```

**Expiration**: Configuration cache invalidated on version change or explicit cache clear.

---

## Summary

This data model provides:
- **Type safety** through JSDoc and JSON Schema validation
- **Consistency** via standardized event protocols
- **Traceability** with timestamps and versioning
- **Extensibility** through metadata and custom props
- **Debuggability** via comprehensive error context

All models align with Vue 3 reactivity system and Wujie event bus architecture.
